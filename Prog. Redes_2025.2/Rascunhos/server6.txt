import socket
import os
import struct

HOST = '127.0.0.1'
PORT = 50000
BUFFER_SIZE = 4096 # Tamanho máximo do pedaço de dados

# 1. Configuração do Socket UDP
server_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
server_socket.bind((HOST, PORT))

print(f"[*] Servidor UDP de Arquivos escutando em {HOST}:{PORT}")

while True:
    try:
        # 2. RECEBE O TAMANHO DO NOME DO ARQUIVO (1 BYTE)
        # O recvfrom() lerá o datagrama completo do cliente.
        # Esperamos que o primeiro byte seja o tamanho do nome.
        data, client_address = server_socket.recvfrom(BUFFER_SIZE)
        
        if not data:
            continue

        # Extrai o tamanho do nome do arquivo (primeiro byte)
        filename_size = struct.unpack('>B', data[:1])[0]
        
        # O nome do arquivo começa após o primeiro byte
        filename_bytes = data[1:1 + filename_size]
        filename = filename_bytes.decode('utf-8')
        
        print(f"\n[*] Solicitação recebida de: {client_address}")
        print(f"[*] Arquivo solicitado: **{filename}**")
        
        # 3. VERIFICA E ENVIA O ARQUIVO
        if os.path.exists(filename):
            print(f"[+] Arquivo encontrado: {filename}")
            
            # Lê o arquivo
            with open(filename, 'rb') as f:
                file_data = f.read()
            
            file_size = len(file_data)
            
            # Estrutura do Datagrama de Resposta:
            # [1 byte: Status '0' (OK)] [8 bytes: Tamanho do Arquivo (Q)] [Dados...]
            
            # Envia o status '0' (OK) e o tamanho do arquivo
            status_and_size = b'0' + struct.pack('>Q', file_size)
            server_socket.sendto(status_and_size, client_address)
            
            # Envia o arquivo em pedaços (simplesmente iterando, sem retransmissão)
            for i in range(0, file_size, BUFFER_SIZE):
                chunk = file_data[i:i + BUFFER_SIZE]
                server_socket.sendto(chunk, client_address)
            
            print(f"[+] Arquivo de {file_size} bytes enviado em {len(file_data)//BUFFER_SIZE + 1} pedaços.")
            
        else:
            print(f"[-] Arquivo NÃO encontrado: {filename}")
            # Envia o status '1' (ERRO)
            server_socket.sendto(b'1', client_address)
            print("[-] Confirmação de 'Arquivo Não Encontrado' enviada.")

    except Exception as e:
        print(f"[-] Erro na comunicação UDP: {e}")